name: Notify Telegram

on:
  push:
    branches:
      - main  # Sostituisci con il branch che desideri monitorare

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Read keyword commit counts
        id: read_counts
        run: |
          if [ -f keyword_commit_counts.json ]; then
            COUNTS=$(cat keyword_commit_counts.json)
          else
            COUNTS='{"grafica":0,"gameplay":0,"storia":0,"meta":0}'
          fi
          echo "::set-output name=counts::$COUNTS"

      - name: Get commit count with keywords
        id: commit_count_keywords
        run: |
          COUNTS=${{ steps.read_counts.outputs.counts }}
          COMMIT_COUNT_GRAFICA=$(git log --grep="grafica" -i --oneline | wc -l)
          COMMIT_COUNT_GAMEPLAY=$(git log --grep="gameplay" -i --oneline | wc -l)
          COMMIT_COUNT_STORIA=$(git log --grep="storia" -i --oneline | wc -l)
          COMMIT_COUNT_META=$(git log --grep="meta" -i --oneline | wc -l)
          NEW_COUNTS=$(echo $COUNTS | jq --argjson grafica $COMMIT_COUNT_GRAFICA --argjson gameplay $COMMIT_COUNT_GAMEPLAY --argjson storia $COMMIT_COUNT_STORIA --argjson meta $COMMIT_COUNT_META '.grafica += $grafica | .gameplay += $gameplay | .storia += $storia | .meta += $meta')
          echo $NEW_COUNTS > keyword_commit_counts.json
          echo "::set-output name=new_counts::$NEW_COUNTS"

      - name: Commit updated counts
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add keyword_commit_counts.json
          git commit -m "Aggiorna conteggi commit parole chiave"
          git push

      - name: Get modified files
        id: modified_files
        run: |
          MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          echo "::set-output name=files::$MODIFIED_FILES"

      - name: Send message to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_URL=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          NEW_COUNTS=${{ steps.commit_count_keywords.outputs.new_counts }}
          MODIFIED_FILES=${{ steps.modified_files.outputs.files }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} -d text="Nuovo commit nel repository: ${{ github.repository }}.\n\nCommit: ${{ github.sha }}\nAutore: $COMMIT_AUTHOR\nMessaggio: $COMMIT_MESSAGE\nLink: $COMMIT_URL\nNumero di commit con parole chiave:\n- Grafica: $(echo $NEW_COUNTS | jq '.grafica')\n- Gameplay: $(echo $NEW_COUNTS | jq '.gameplay')\n- Storia: $(echo $NEW_COUNTS | jq '.storia')\n- Meta: $(echo $NEW_COUNTS | jq '.meta')\n\nFile modificati:\n$MODIFIED_FILES"
