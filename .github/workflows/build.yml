name: Notify Telegram

on:
  push:
    branches:
      - master  # Sostituisci con il branch che desideri monitorare

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get original commit details
        id: original_commit
        run: |
          ORIGINAL_COMMIT_SHA=$(git rev-parse HEAD)
          ORIGINAL_COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s' $ORIGINAL_COMMIT_SHA)
          ORIGINAL_COMMIT_DESCRIPTION=$(git log -1 --pretty=format:'%b' $ORIGINAL_COMMIT_SHA)
          ORIGINAL_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an' $ORIGINAL_COMMIT_SHA)
          MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r $ORIGINAL_COMMIT_SHA)
          echo "::set-output name=sha::$ORIGINAL_COMMIT_SHA"
          echo "::set-output name=message::$ORIGINAL_COMMIT_MESSAGE"
          echo "::set-output name=description::$ORIGINAL_COMMIT_DESCRIPTION"
          echo "::set-output name=author::$ORIGINAL_COMMIT_AUTHOR"
          echo "::set-output name=files::$MODIFIED_FILES"

      - name: Read keyword commit counts
        id: read_counts
        run: |
          if [ -f keyword_commit_counts.json ]; then
            COUNTS=$(cat keyword_commit_counts.json)
          else
            COUNTS='{"grafica":0,"gameplay":0,"storia":0,"meta":0}'
          fi
          echo "::set-output name=counts::$COUNTS"

      - name: Get commit count with keywords
        id: commit_count_keywords
        run: |
          COUNTS='${{ steps.read_counts.outputs.counts }}'
          COMMIT_COUNT_GRAFICA=$(git log --grep="grafica" -i --oneline | wc -l)
          COMMIT_COUNT_GAMEPLAY=$(git log --grep="gameplay" -i --oneline | wc -l)
          COMMIT_COUNT_STORIA=$(git log --grep="storia" -i --oneline | wc -l)
          COMMIT_COUNT_META=$(git log --grep="meta" -i --oneline | wc -l)
          NEW_COUNTS=$(echo $COUNTS | jq --argjson grafica $COMMIT_COUNT_GRAFICA --argjson gameplay $COMMIT_COUNT_GAMEPLAY --argjson storia $COMMIT_COUNT_STORIA --argjson meta $COMMIT_COUNT_META '.grafica += ($grafica | tonumber) | .gameplay += ($gameplay | tonumber) | .storia += ($storia | tonumber) | .meta += ($meta | tonumber)')
          echo $NEW_COUNTS > keyword_commit_counts.json
          echo "::set-output name=new_counts::$NEW_COUNTS"

      - name: Get commit author
        id: commit_author
        run: |
          COMMIT_AUTHOR_NAME=$(git log -1 --pretty=format:'%an')
          COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "::set-output name=name::$COMMIT_AUTHOR_NAME"
          echo "::set-output name=email::$COMMIT_AUTHOR_EMAIL"

      - name: Commit updated counts
        run: |
          git config --global user.name '${{ steps.commit_author.outputs.name }}'
          git config --global user.email '${{ steps.commit_author.outputs.email }}'
          git add keyword_commit_counts.json
          git commit -m "Aggiorna conteggi commit parole chiave"
          git push

      - name: Send message to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          ORIGINAL_COMMIT_SHA=${{ steps.original_commit.outputs.sha }}
          ORIGINAL_COMMIT_MESSAGE=${{ steps.original_commit.outputs.message }}
          ORIGINAL_COMMIT_DESCRIPTION=${{ steps.original_commit.outputs.description }}
          ORIGINAL_COMMIT_AUTHOR=${{ steps.original_commit.outputs.author }}
          COMMIT_URL=${{ github.server_url }}/${{ github.repository }}/commit/$ORIGINAL_COMMIT_SHA
          COUNTS=$(cat keyword_commit_counts.json)
          COMMIT_COUNT_GRAFICA=$(echo $COUNTS | jq '.grafica')
          COMMIT_COUNT_GAMEPLAY=$(echo $COUNTS | jq '.gameplay')
          COMMIT_COUNT_STORIA=$(echo $COUNTS | jq '.storia')
          COMMIT_COUNT_META=$(echo $COUNTS | jq '.meta')
          MODIFIED_FILES=${{ steps.original_commit.outputs.files }}
          MESSAGE=$(printf "Nuovo commit nel repository: ${{ github.repository }}.\n\nCommit: $ORIGINAL_COMMIT_SHA\nAutore: $ORIGINAL_COMMIT_AUTHOR\nMessaggio: $ORIGINAL_COMMIT_MESSAGE\nDescrizione: $ORIGINAL_COMMIT_DESCRIPTION\nLink: $COMMIT_URL\n\nNumero di commit con parole chiave:\n- Grafica: $COMMIT_COUNT_GRAFICA\n- Gameplay: $COMMIT_COUNT_GAMEPLAY\n- Storia: $COMMIT_COUNT_STORIA\n- Meta: $COMMIT_COUNT_META\n\nFile modificati:\n$MODIFIED_FILES")
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} -d text="$MESSAGE"
