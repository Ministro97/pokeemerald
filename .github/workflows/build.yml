name: Notify Telegram

on:
  push:
    branches:
      - master  # Sostituisci con il branch che desideri monitorare

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get commit count with keywords
        id: commit_count_keywords
        run: |
          COMMIT_COUNT_GRAFICA=$(git log --grep="grafica" -i --oneline | wc -l)
          COMMIT_COUNT_GAMEPLAY=$(git log --grep="gameplay" -i --oneline | wc -l)
          COMMIT_COUNT_STORIA=$(git log --grep="storia" -i --oneline | wc -l)
          COMMIT_COUNT_META=$(git log --grep="meta" -i --oneline | wc -l)
          echo "::set-output name=count_grafica::$COMMIT_COUNT_GRAFICA"
          echo "::set-output name=count_gameplay::$COMMIT_COUNT_GAMEPLAY"
          echo "::set-output name=count_storia::$COMMIT_COUNT_STORIA"
          echo "::set-output name=count_meta::$COMMIT_COUNT_META"

      - name: Get modified files
        id: modified_files
        run: |
          MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          echo "::set-output name=files::$MODIFIED_FILES"

      - name: Send message to Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_URL=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          COMMIT_COUNT_GRAFICA=${{ steps.commit_count_keywords.outputs.count_grafica }}
          COMMIT_COUNT_GAMEPLAY=${{ steps.commit_count_keywords.outputs.count_gameplay }}
          COMMIT_COUNT_STORIA=${{ steps.commit_count_keywords.outputs.count_storia }}
          COMMIT_COUNT_META=${{ steps.commit_count_keywords.outputs.count_meta }}
          MODIFIED_FILES=${{ steps.modified_files.outputs.files }}
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} -d text="Nuovo commit nel repository: ${{ github.repository }}.\n\nCommit: ${{ github.sha }}\nAutore: $COMMIT_AUTHOR\nMessaggio: $COMMIT_MESSAGE\nLink: $COMMIT_URL\nNumero di commit con parole chiave:\n- Grafica: $COMMIT_COUNT_GRAFICA\n- Gameplay: $COMMIT_COUNT_GAMEPLAY\n- Storia: $COMMIT_COUNT_STORIA\n- Meta: $COMMIT_COUNT_META\n\nFile modificati:\n$MODIFIED_FILES"
